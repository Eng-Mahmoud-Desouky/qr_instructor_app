# QR Code Scanning Integration Guide
## Technical Specification for Student App Integration

---

## Overview
This document provides technical specifications for implementing QR code scanning functionality in the student attendance application. The QR codes are generated by the instructor app and contain attendance verification data.

---

## QR Code Data Structure

### Format
The QR code contains a **JSON string** with the following structure:

```json
{
  "qrCodeId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "uuidTokenHash": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6"
}
```

### Field Descriptions

| Field | Type | Description |
|-------|------|-------------|
| `qrCodeId` | UUID (String) | Unique identifier for this specific QR code instance. Generated by the backend when the instructor creates the QR code. |
| `uuidTokenHash` | String | Security token hash used to verify the authenticity of the attendance request. |

### Important Notes
- The QR code string is **encoded as JSON**, not plain text
- Both fields are **required** for attendance marking
- The QR code expires after the duration specified by the instructor
- Each QR code is unique per lecture session

---

## Implementation Steps for Student App

### Step 1: Scan QR Code
Use any QR code scanning library (e.g., `mobile_scanner`, `qr_code_scanner` for Flutter) to scan the code.

**Example (Flutter):**
```dart
import 'package:mobile_scanner/mobile_scanner.dart';
import 'dart:convert';

// In your scanner widget
MobileScanner(
  onDetect: (capture) {
    final List<Barcode> barcodes = capture.barcodes;
    for (final barcode in barcodes) {
      final String? rawValue = barcode.rawValue;
      if (rawValue != null) {
        _handleScannedQR(rawValue);
      }
    }
  },
)
```

### Step 2: Parse JSON Data
Extract the `qrCodeId` and `uuidTokenHash` from the scanned string.

**Example Code:**
```dart
void _handleScannedQR(String qrData) {
  try {
    // Parse JSON string
    final Map<String, dynamic> decoded = jsonDecode(qrData);
    
    // Extract fields
    final String qrCodeId = decoded['qrCodeId'];
    final String uuidTokenHash = decoded['uuidTokenHash'];
    
    // Validate fields exist
    if (qrCodeId.isEmpty || uuidTokenHash.isEmpty) {
      throw Exception('Invalid QR code: missing required fields');
    }
    
    // Proceed to mark attendance
    _markAttendance(qrCodeId, uuidTokenHash);
    
  } catch (e) {
    // Handle parsing errors
    print('Error parsing QR code: $e');
    _showError('Invalid QR code format');
  }
}
```

### Step 3: Collect Device Information
Gather required device and network information.

**Required Data:**
```dart
class AttendanceRequest {
  // From QR Code
  final String qrCodeId;
  final String uuidTokenHash;
  
  // From Student Session
  final String studentAcademicMemberId; // From logged-in user
  final String lectureId; // Can be obtained from backend using qrCodeId
  
  // Device Information
  final String ipAddress;
  final String deviceId;
}
```

**Example - Getting IP Address:**
```dart
import 'package:network_info_plus/network_info_plus.dart';

Future<String> getIpAddress() async {
  final info = NetworkInfo();
  final wifiIP = await info.getWifiIP();
  return wifiIP ?? '0.0.0.0';
}
```

**Example - Getting Device ID:**
```dart
import 'package:device_info_plus/device_info_plus.dart';
import 'dart:io';

Future<String> getDeviceId() async {
  final deviceInfo = DeviceInfoPlugin();
  if (Platform.isAndroid) {
    final androidInfo = await deviceInfo.androidInfo;
    return androidInfo.id; // Unique Android ID
  } else if (Platform.isIOS) {
    final iosInfo = await deviceInfo.iosInfo;
    return iosInfo.identifierForVendor ?? 'unknown';
  }
  return 'unknown';
}
```

---

## API Integration

### Base URL
```
https://smart-attendance-system-production-253e.up.railway.app
```

### Authentication
All requests must include the Bearer token obtained during student login.

**Headers:**
```http
Authorization: Bearer YOUR_ACCESS_TOKEN_HERE
Content-Type: application/json
```

---

## Mark Attendance Endpoint

### Endpoint Details
```
PUT /api/v1/attendance/mark-as-present
```

### Query Parameters
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `studentId` | UUID | Yes | Student's academic member ID (from login session) |
| `lectureId` | UUID | Yes | Lecture ID (can be fetched using QR code ID) |

### Request Body
```json
{
  "requestAttendance": {
    "ipAddress": "192.168.1.100",
    "deviceId": "android-abc123xyz",
    "lectureId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "qrCodeId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "studentAcademicMemberId": "3fa85f64-5717-4562-b3fc-2c963f66afa6"
  },
  "requestQrGenerator": {
    "qrCodeId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "uuidTokenHash": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6"
  }
}
```

### Complete Implementation Example

```dart
import 'package:dio/dio.dart';
import 'dart:convert';

class AttendanceService {
  final Dio _dio;
  final String _baseUrl = 'https://smart-attendance-system-production-253e.up.railway.app';
  
  AttendanceService(this._dio);
  
  Future<void> markAttendance({
    required String qrCodeId,
    required String uuidTokenHash,
    required String studentId,
    required String lectureId,
  }) async {
    try {
      // Get device information
      final ipAddress = await getIpAddress();
      final deviceId = await getDeviceId();
      
      // Prepare request body
      final requestBody = {
        "requestAttendance": {
          "ipAddress": ipAddress,
          "deviceId": deviceId,
          "lectureId": lectureId,
          "qrCodeId": qrCodeId,
          "studentAcademicMemberId": studentId,
        },
        "requestQrGenerator": {
          "qrCodeId": qrCodeId,
          "uuidTokenHash": uuidTokenHash,
        }
      };
      
      // Make API request
      final response = await _dio.put(
        '$_baseUrl/api/v1/attendance/mark-as-present',
        queryParameters: {
          'studentId': studentId,
          'lectureId': lectureId,
        },
        data: requestBody,
      );
      
      if (response.statusCode == 200) {
        print('Attendance marked successfully');
      }
      
    } on DioException catch (e) {
      if (e.response?.statusCode == 401) {
        throw Exception('Authentication failed');
      } else if (e.response?.statusCode == 400) {
        throw Exception('Invalid QR code or expired');
      } else if (e.response?.statusCode == 409) {
        throw Exception('Attendance already marked');
      }
      throw Exception('Failed to mark attendance: ${e.message}');
    }
  }
}
```

---

## Getting Lecture ID from QR Code

If the lecture ID is not directly available, you can fetch it using the QR code ID:

### Endpoint
```
GET /api/v1/qr-code/find-by-lecture?lectureId={lectureId}
```

Or you may need to add a helper endpoint on the backend to get lecture info from QR code ID.

**Alternative Approach:** Include `lectureId` in the QR code JSON:
```json
{
  "qrCodeId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "lectureId": "7fa85f64-5717-4562-b3fc-2c963f66afa7",
  "uuidTokenHash": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6"
}
```

---

## Error Handling

### Common Error Codes

| Status Code | Meaning | Suggested Action |
|-------------|---------|------------------|
| 200 | Success | Show success message to student |
| 400 | Bad Request | Invalid data format or expired QR code |
| 401 | Unauthorized | Student needs to login again |
| 404 | Not Found | QR code or lecture not found |
| 409 | Conflict | Attendance already marked for this lecture |
| 500 | Server Error | Try again later |

### Example Error Handling

```dart
void handleAttendanceError(Exception error) {
  String message;
  
  if (error.toString().contains('expired')) {
    message = 'QR code has expired. Please ask instructor for new code.';
  } else if (error.toString().contains('already marked')) {
    message = 'Your attendance is already recorded for this lecture.';
  } else if (error.toString().contains('Authentication')) {
    message = 'Please login again.';
  } else {
    message = 'Failed to mark attendance. Please try again.';
  }
  
  showDialog(
    context: context,
    builder: (context) => AlertDialog(
      title: Text('Error'),
      content: Text(message),
      actions: [
        TextButton(
          onPressed: () => Navigator.pop(context),
          child: Text('OK'),
        ),
      ],
    ),
  );
}
```

---

## Security Considerations

1. **Token Validation**: The `uuidTokenHash` is validated on the server to prevent fraudulent attendance
2. **Expiration**: QR codes expire after the specified duration (e.g., 10 minutes)
3. **Network Verification**: The system may verify the student's IP address matches expected network
4. **One-time Use**: Some implementations may invalidate the QR after first successful scan
5. **Rate Limiting**: Prevent spam by limiting scan attempts

---

## Testing Checklist

- [ ] QR code scanning works on different lighting conditions
- [ ] JSON parsing handles malformed data gracefully
- [ ] Network errors are handled properly
- [ ] Expired QR codes show appropriate message
- [ ] Duplicate attendance attempts are prevented
- [ ] UI feedback is clear (loading, success, error)
- [ ] Works offline (with proper error message)
- [ ] Authentication token refresh works

---

## Complete Flow Diagram

```
┌─────────────────┐
│  Student Opens  │
│   Scanner App   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   Scan QR Code  │
│                 │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Parse JSON:    │
│  - qrCodeId     │
│  - tokenHash    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Collect Device  │
│ Info (IP, ID)   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Send Request   │
│  to Backend     │
└────────┬────────┘
         │
         ▼
    ┌────┴────┐
    │ Success?│
    └────┬────┘
         │
    ┌────┴────────┐
    │             │
   YES           NO
    │             │
    ▼             ▼
┌────────┐   ┌─────────┐
│ Show   │   │  Show   │
│Success │   │ Error   │
└────────┘   └─────────┘
```

---

## Dependencies (Flutter)

Add these to your `pubspec.yaml`:

```yaml
dependencies:
  dio: ^5.4.0
  mobile_scanner: ^4.0.0
  network_info_plus: ^5.0.0
  device_info_plus: ^10.0.0
  flutter_secure_storage: ^9.0.0
```

---

## FAQ

**Q: What if the QR code is already scanned?**  
A: The API will return a 409 Conflict error. Show a message that attendance is already recorded.

**Q: How do I know if the QR code is still valid?**  
A: The backend validates expiration. If expired, you'll get a 400 Bad Request error.

**Q: Should I store the QR data locally?**  
A: No. QR codes are single-use and time-limited. Don't cache them.

**Q: What if the student is not on the correct network?**  
A: The backend may validate the network. If validation fails, show an appropriate error message.

---

## Support & Contact

For technical issues or questions about integration, refer to:
- API Base URL: `https://smart-attendance-system-production-253e.up.railway.app`
- API Documentation: Check with backend team for Swagger/OpenAPI docs

---

**Last Updated:** 2025-12-10  
**Version:** 1.0  
**Compatible with:** Instructor App v1.0+
